# vim: set filetype=zsh

export DISABLE_SPRING=1
export EDITOR="/opt/homebrew/bin/nvim"
export LANG=ja_JP.UTF-8
export LC_CTYPE=ja_JP.UTF-8

# Lazy loading for version managers (performance optimization)
# Instead of running expensive eval commands on every shell startup,
# we define wrapper functions that initialize on first use.
_lazy_anyenv_manager() {
  local tool="$1"
  local root=""

  if [ -d "$HOME/.anyenv/envs/$tool" ]; then
    root="$HOME/.anyenv/envs/$tool"
  elif [ -d "$HOME/.${tool}" ]; then
    root="$HOME/.${tool}"
  else
    return
  fi

  local bin_dir="$root/bin"
  local shim_dir="$root/shims"
  local tool_path="$bin_dir/$tool"
  if [ ! -x "$tool_path" ]; then
    tool_path="$(command -v "$tool" 2>/dev/null)" || return
    bin_dir="${tool_path:h}"
  fi
  local upper="${tool:u}"
  eval "export ${upper}_ROOT=\"$root\""

  # Move bin and shim dirs to the front of $PATH (deduplicating if present)
  if [ -d "$bin_dir" ]; then
    path=("$bin_dir" "${(@)path:#$bin_dir}")
  fi
  if [ -d "$shim_dir" ]; then
    path=("$shim_dir" "${(@)path:#$shim_dir}")
  fi

  eval "
$tool() {
  unfunction $tool
  eval \"\$($tool_path init -)\"
  # goenvã®å ´åˆã€GOROOTã‚‚è¨­å®š
  if [[ \"$tool\" == \"goenv\" ]] && type go > /dev/null 2>&1; then
    export GOROOT=\$(go env GOROOT)
  fi
  $tool \"\$@\"
}
"
}

if type anyenv > /dev/null 2>&1; then
  anyenv() {
    unfunction anyenv
    eval "$(command anyenv init -)"
    anyenv "$@"
  }
fi

if type direnv > /dev/null 2>&1; then
  # direnv needs to be initialized immediately for auto-loading .envrc files
  eval "$(direnv hook zsh)"
fi

export PATH=$HOME/.nodebrew/current/bin:$PATH
export GOPATH=$HOME/go
export PATH=$GOPATH/bin:$PATH
export PATH="$HOME/dotfiles/bin:$PATH"
export PATH="/opt/homebrew/bin:$PATH"
export PATH="/usr/local/heroku/bin:$PATH"

for _env in rbenv nodenv goenv; do
  _lazy_anyenv_manager "$_env"
done
unset _env

export HUSKY_SKIP_HOOKS=1
export FZF_DEFAULT_OPTS='--height 80% --reverse --border'
FZF_GIT_BRANCH_OPTS='--no-sort --no-hscroll --preview-window=down'
if [[ -z "${FZF_CTRL_R_OPTS:-}" ]]; then
  export FZF_CTRL_R_OPTS="$FZF_GIT_BRANCH_OPTS"
fi


if [ -s ~/.zshrc ]; then
  if [ ! -s ~/.zshrc.zwc ] || [ ~/.zshrc -nt ~/.zshrc.zwc ]; then
    zcompile ~/.zshrc
  fi
fi

##========================================================##
##================== ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã®è¨­å®š ==================##
##========================================================##
bindkey -e      # emacs ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰
# bindkey -v      # vi ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰
# set -o vi
bindkey -r '^T'

##========================================================##
##================= ãƒªã‚¹ãƒˆã®è‰²ã¤ã‘ã®è¨­å®š =================##
##========================================================##
# ls, #dir, vdir ã®è¨­å®š
alias sk='kill -9 $$'
alias grep='grep --color=auto'
alias tn='terminal-notifier -sound default'
export MAILCHECK=0
export LS_COLORS='di=34:ln=35:so=32:pi=33:ex=31:bd=46;34:cd=43;34:su=41;30:sg=46;30:tw=42;30:ow=43;30'
# è£œå®Œå€™è£œã«ã‚‚è‰²ä»˜ãè¡¨ç¤º
zstyle ':completion:*:default' list-colors ${(s.:.)LS_COLORS}
# kill ã®å€™è£œã«ã‚‚è‰²ä»˜ãè¡¨ç¤º
zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([%0-9]#)*=0=01;31'

##========================================================##
##====================== è£œå®Œã®è¨­å®š ======================##
##========================================================##
# Speed up completion init by caching the compiled dump under ~/.cache
autoload -Uz compinit
: "${XDG_CACHE_HOME:=$HOME/.cache}"
: "${ZSH_COMPDUMP:=$XDG_CACHE_HOME/zsh/zcompdump-$ZSH_VERSION}"
compdump_dir="${ZSH_COMPDUMP:h}"
if [[ ! -d "$compdump_dir" ]]; then
  if ! mkdir -p "$compdump_dir" 2>/dev/null; then
    ZSH_COMPDUMP="$HOME/.zcompdump"
    compdump_dir="${ZSH_COMPDUMP:h}"
  fi
fi
if [[ -s "$ZSH_COMPDUMP" ]]; then
  compinit -C -d "$ZSH_COMPDUMP"
else
  compinit -d "$ZSH_COMPDUMP"
fi
if [[ -s "$ZSH_COMPDUMP" && ( ! -s "${ZSH_COMPDUMP}.zwc" || "$ZSH_COMPDUMP" -nt "${ZSH_COMPDUMP}.zwc" ) ]]; then
  zcompile "$ZSH_COMPDUMP"
fi
# è£œå®Œå€™è£œã®å¤§æ–‡å­—å°æ–‡å­—ã®é•ã„ã‚’ç„¡è¦–
#zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'
zstyle ':completion:*:default' menu select=1 # è£œå®Œå€™è£œã‚’â†â†“â†‘â†’ã§é¸æŠ
zstyle ':completion:*' use-cache true        # è£œå®Œã‚­ãƒ£ãƒƒã‚·ãƒ¥
# kill ã§ 'ps x' ã®ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠå¯èƒ½
zstyle ':completion:*:processes' command 'ps x'

setopt list_packed           # ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«è£œå®Œãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
#setopt auto_remove_slash     # è£œå®Œã§æœ«å°¾ã«è£œã‚ã‚ŒãŸ / ã‚’è‡ªå‹•çš„ã«å‰Šé™¤
unsetopt auto_remove_slash
setopt auto_param_slash      # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã®è£œå®Œã§æœ«å°¾ã® / ã‚’è‡ªå‹•çš„ã«ä»˜åŠ ã—ã€æ¬¡ã®è£œå®Œã«å‚™ãˆã‚‹
setopt mark_dirs             # ãƒ•ã‚¡ã‚¤ãƒ«åã®å±•é–‹ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒãƒƒãƒã—ãŸå ´åˆ æœ«å°¾ã« / ã‚’ä»˜åŠ 
setopt list_types            # è£œå®Œå€™è£œä¸€è¦§ã§ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®åˆ¥ã‚’è­˜åˆ¥ãƒãƒ¼ã‚¯è¡¨ç¤º (è¨³æ³¨:ls -F ã®è¨˜å·)
unsetopt menu_complete       # è£œå®Œã®éš›ã«ã€å¯èƒ½ãªãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã¦ãƒ“ãƒ¼ãƒ—ã‚’é³´ã‚‰ã™ã®ã§ã¯ãªãã€
                        # æœ€åˆã«ãƒãƒƒãƒã—ãŸã‚‚ã®ã‚’ã„ããªã‚ŠæŒ¿å…¥ã€ã¯ã—ãªã„
setopt auto_list             # ^Iã§è£œå®Œå¯èƒ½ãªä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹(è£œå®Œå€™è£œãŒè¤‡æ•°ã‚ã‚‹æ™‚ã«ã€ä¸€è¦§è¡¨ç¤º)
setopt auto_menu             # è£œå®Œã‚­ãƒ¼é€£æ‰“ã§é †ã«è£œå®Œå€™è£œã‚’è‡ªå‹•ã§è£œå®Œ
setopt auto_param_keys       # ã‚«ãƒƒã‚³ã®å¯¾å¿œãªã©ã‚’è‡ªå‹•çš„ã«è£œå®Œ
setopt auto_resume           # ã‚µã‚¹ãƒšãƒ³ãƒ‰ä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã¨åŒã˜ã‚³ãƒãƒ³ãƒ‰åã‚’å®Ÿè¡Œã—ãŸå ´åˆã¯ãƒªã‚¸ãƒ¥ãƒ¼ãƒ 

#setopt auto_correct          # è£œå®Œæ™‚ã«ã‚¹ãƒšãƒ«ãƒã‚§ãƒƒã‚¯
#setopt correct               # ã‚¹ãƒšãƒ«ãƒŸã‚¹ã‚’è£œå®Œ
#setopt correct_all           # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å…¨ã¦ã®ã‚¹ãƒšãƒ«ãƒã‚§ãƒƒã‚¯ã‚’ã™ã‚‹

##========================================================##
##==================== git branchã®æ¤œç´¢ ====================##
##========================================================##
# NOTE: https://www.mizdra.net/entry/2024/10/19/172323
user_name=$(git config user.name)
fmt="\
%(if:equals=$user_name)%(authorname)%(then)%(color:default)%(else)%(color:brightred)%(end)%(refname:short)|\
%(committerdate:relative)|\
%(subject)"
function select-git-branch-friendly() {
  selected_branch=$(
    git branch --sort=-committerdate --format=$fmt --color=always \
    | column -ts'|' \
    | FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS $FZF_GIT_BRANCH_OPTS" \
      fzf --ansi --exact --preview='git log --oneline --graph --decorate --color=always -50 {+1}' \
    | awk '{print $1}' \
  )
  BUFFER="${LBUFFER}${selected_branch}${RBUFFER}"
  CURSOR=$#LBUFFER+$#selected_branch
  zle redisplay
}
zle -N select-git-branch-friendly
bindkey '^g^b' select-git-branch-friendly

##========================================================##
##====================== å±¥æ­´ã®è¨­å®š ======================##
##========================================================##
HISTFILE=$HOME/.zsh_history  # å±¥æ­´ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹
HISTSIZE=1000000              # ãƒ¡ãƒ¢ãƒªå†…ã®å±¥æ­´ã®æ•°
SAVEHIST=1000000              # ä¿å­˜ã•ã‚Œã‚‹å±¥æ­´ã®æ•°
setopt extended_history      # å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã«é–‹å§‹æ™‚åˆ»ã¨çµŒéæ™‚é–“ã‚’è¨˜éŒ²
setopt append_history        # å±¥æ­´ã‚’è¿½åŠ  (æ¯å› .zhistory ã‚’ä½œã‚‹ã®ã§ã¯ãªã)
setopt inc_append_history    # å±¥æ­´ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ã«è¿½åŠ 
setopt share_history         # å±¥æ­´ã®å…±æœ‰
setopt hist_ignore_all_dups  # é‡è¤‡ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰è¡Œã¯å¤ã„æ–¹ã‚’å‰Šé™¤
setopt hist_ignore_dups      # ç›´å‰ã¨åŒã˜ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã¯ãƒ’ã‚¹ãƒˆãƒªã«è¿½åŠ ã—ãªã„
setopt hist_ignore_space     # ã‚¹ãƒšãƒ¼ã‚¹ã§å§‹ã¾ã‚‹ã‚³ãƒãƒ³ãƒ‰è¡Œã¯ãƒ’ã‚¹ãƒˆãƒªãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                        # (â†’ å…ˆé ­ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œã¦ãŠã‘ã°ã€ãƒ’ã‚¹ãƒˆãƒªã«ä¿å­˜ã•ã‚Œãªã„)
unsetopt hist_verify         # ãƒ’ã‚¹ãƒˆãƒªã‚’å‘¼ã³å‡ºã—ã¦ã‹ã‚‰å®Ÿè¡Œã™ã‚‹é–“ã«ä¸€æ—¦ç·¨é›†å¯èƒ½ã‚’æ­¢ã‚ã‚‹
setopt hist_reduce_blanks    # ä½™åˆ†ãªç©ºç™½ã¯è©°ã‚ã¦è¨˜éŒ²
setopt hist_save_no_dups     # ãƒ’ã‚¹ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™ã¨ãã«ã€å¤ã„ã‚³ãƒãƒ³ãƒ‰ã¨åŒã˜ã‚‚ã®ã¯ç„¡è¦–ã™ã‚‹ã€‚
setopt hist_no_store         # historyã‚³ãƒãƒ³ãƒ‰ã¯å±¥æ­´ã«ç™»éŒ²ã—ãªã„
setopt hist_expand           # è£œå®Œæ™‚ã«ãƒ’ã‚¹ãƒˆãƒªã‚’è‡ªå‹•çš„ã«å±•é–‹

# å…¨å±¥æ­´ã®ä¸€è¦§ã‚’å‡ºåŠ›ã™ã‚‹
function history-all { history -E 1 }

##========================================================##
##=================== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­å®š ===================##
##========================================================##
# https://qiita.com/kumatira/items/41562f1d9001927e9888
autoload -U promptinit ; promptinit
autoload -U colors     ; colors
autoload -Uz vcs_info
setopt prompt_subst
# zstyle ':vcs_info:git:*' formats '%b'
zstyle ':vcs_info:git:*' formats '%F{black}%K{green}[%b]%f%k'
precmd () { vcs_info }
PROMPT='%B%50<..<%~ %b${vcs_info_msg_0_}'
PROMPT+='%(?.%(!.%F{white}â¯%F{yellow}â¯%F{red}.%F{blue}â¯%F{cyan}â¯%F{green})â¯.%F{red}â¯â¯â¯)%f '
##========================================================##
##================ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•ã®è¨­å®š ================##
##========================================================##
setopt auto_cd               # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿ã§ç§»å‹•
setopt auto_pushd            # æ™®é€šã« cd ã™ã‚‹ã¨ãã«ã‚‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¹ã‚¿ãƒƒã‚¯ã«ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å…¥ã‚Œã‚‹
setopt pushd_ignore_dups     # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¹ã‚¿ãƒƒã‚¯ã«é‡è¤‡ã™ã‚‹ç‰©ã¯å¤ã„æ–¹ã‚’å‰Šé™¤
setopt pushd_to_home         # pushd å¼•æ•°ãƒŠã‚· == pushd $HOME
setopt pushd_silent          # pushd,popdã®åº¦ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¹ã‚¿ãƒƒã‚¯ã®ä¸­èº«ã‚’è¡¨ç¤ºã—ãªã„

##========================================================##
##====================== é›‘å¤šãªè¨­å®š ======================##
##========================================================##
#setopt AUTOLOGOUT=n          # nåˆ†å¾Œã«è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
setopt no_beep               # ã‚³ãƒãƒ³ãƒ‰å…¥åŠ›ã‚¨ãƒ©ãƒ¼ã§Beepã‚’é³´ã‚‰ã•ãªã„

setopt complete_in_word
setopt extended_glob         # æ‹¡å¼µã‚°ãƒ­ãƒ–ã‚’æœ‰åŠ¹ã«ã™ã‚‹
setopt brace_ccl             # ãƒ–ãƒ¬ãƒ¼ã‚¹å±•é–‹æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹
setopt equals                # =COMMAND ã‚’ COMMAND ã®ãƒ‘ã‚¹åã«å±•é–‹
setopt numeric_glob_sort     # æ•°å­—ã‚’æ•°å€¤ã¨è§£é‡ˆã—ã¦ã‚½ãƒ¼ãƒˆã™ã‚‹
setopt path_dirs             # ã‚³ãƒãƒ³ãƒ‰åã« / ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¨ã PATH ä¸­ã®ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¢ã™
setopt print_eight_bit       # è£œå®Œå€™è£œãƒªã‚¹ãƒˆã®æ—¥æœ¬èªã‚’é©æ­£è¡¨ç¤º
setopt auto_name_dirs

unsetopt flow_control        # (shell editor å†…ã§) C-s, C-q ã‚’ç„¡åŠ¹ã«ã™ã‚‹
setopt no_flow_control       # C-s/C-q ã«ã‚ˆã‚‹ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ã‚’ä½¿ã‚ãªã„
setopt hash_cmds             # å„ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ãã«ãƒ‘ã‚¹ã‚’ãƒãƒƒã‚·ãƒ¥ã«å…¥ã‚Œã‚‹

#setopt ignore_eof            # C-dã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãªã„

setopt bsd_echo
setopt no_hup                # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã‚’killã—ãªã„
#setopt no_checkjobs          # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã‚’ç¢ºèªã—ãªã„
setopt notify                # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ãŒçµ‚äº†ã—ãŸã‚‰(ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¡¨ç¤ºã‚’å¾…ãŸãšã«)ã™ãã«çŸ¥ã‚‰ã›ã‚‹
setopt long_list_jobs        # å†…éƒ¨ã‚³ãƒãƒ³ãƒ‰ jobs ã®å‡ºåŠ›ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ jobs -L ã«ã™ã‚‹

setopt magic_equal_subst     # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®å¼•æ•°ã§ --PREFIX=/USR ãªã©ã® = ä»¥é™ã§ã‚‚è£œå®Œã§ãã‚‹
#setopt mail_warning
setopt multios               # è¤‡æ•°ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚„ãƒ‘ã‚¤ãƒ—ãªã©ã€å¿…è¦ã«å¿œã˜ã¦ TEE ã‚„ CAT ã®æ©Ÿèƒ½ãŒä½¿ã‚ã‚Œã‚‹
setopt short_loops           # FOR, REPEAT, SELECT, IF, FUNCTION ãªã©ã§ç°¡ç•¥æ–‡æ³•ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹
#setopt sun_keyboard_hack     # SUNã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã®é »å‡º typo ` ã‚’ã‚«ãƒãƒ¼ã™ã‚‹
setopt always_last_prompt    # ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã¯ä¿æŒã—ãŸã¾ã¾ãƒ•ã‚¡ã‚¤ãƒ«åä¸€è¦§ã‚’é †æ¬¡ãã®å ´ã§è¡¨ç¤º
setopt cdable_vars sh_word_split

setopt rm_star_wait          # rm * ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ç¢ºèª
#setopt rm_star_silent        # rm * ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ç¢ºèªã—ãªã„
#setopt no_clobber            # ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§ä¸Šæ›¸ãã‚’ç¦æ­¢
unsetopt no_clobber

# setopt no_unset              # æœªå®šç¾©å¤‰æ•°ã®ä½¿ç”¨ç¦æ­¢

#setopt interactive_comments  # ã‚³ãƒãƒ³ãƒ‰å…¥åŠ›ä¸­ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’èªã‚ã‚‹
#setopt chase_links           # ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã¯ãƒªãƒ³ã‚¯å…ˆã®ãƒ‘ã‚¹ã«å¤‰æ›ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
#setopt print_exit_value      # æˆ»ã‚Šå€¤ãŒ 0 ä»¥å¤–ã®å ´åˆçµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
#setopt single_line_zle       # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¤‡æ•°è¡Œã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ç·¨é›†ã§ã¯ãªãã€ï¼‘è¡Œç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚‹
#setopt xtrace                # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãŒã©ã®ã‚ˆã†ã«å±•é–‹ã•ã‚Œå®Ÿè¡Œã•ã‚ŒãŸã‹ã‚’è¡¨ç¤ºã™ã‚‹

# less ã®å‹•ä½œï¼ˆman less å‚ç…§ï¼‰
LESS=-M
export LESS

umask 022 # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ã¨ãã€ã©ã‚“ãªå±æ€§ã§ä½œã‚‹ã‹ï¼ˆman umask å‚ç…§ï¼‰
ulimit -s unlimited  # stack size åˆ¶é™è§£é™¤
ulimit -Sn 524288
limit coredumpsize 0 # core æŠ‘åˆ¶
# Grip ãªã©Glibã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‡ºåŠ›ã§ã®æ–‡å­—åŒ–ã‘é˜²æ­¢
export G_FILENAME_ENCODING=@locale

# google æ¤œç´¢
function google() {
  local str
  if [ $# != 0 ]; then # å¼•æ•°ãŒå­˜åœ¨ã™ã‚Œã°
    for i in $*; do
      str="$str+$i"
    done
    str=`echo $str | sed 's/^\+//'` #å…ˆé ­ã®ã€Œ+ã€ã‚’å‰Šé™¤
  fi
  open "http://www.google.co.jp/search?hl=ja&q=$str"
}
# wikipedia æ¤œç´¢
function wikipedia() { open "https://ja.wikipedia.org/w/index.php?search=$1" }

# ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
function find-grep () { find . -type f -print | xargs grep -n --binary-files=without-match $@ }

# ç¾åœ¨ã®git branchåã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
function gb() {
  if [ "$#" -gt 0 ]; then
    git branch "$@"
  else
    branch_name=$(git branch | grep \* | cut -d ' ' -f2)
    echo -n "$branch_name" | tr -d '\n' | pbcopy
    echo "ãƒ–ãƒ©ãƒ³ãƒå '$branch_name' ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
  fi
}


# Global alias
alias be="bundle exec"
alias b="bundle exec"

# ls colorization
if [[ "$OSTYPE" == linux* ]]; then
  alias ls='ls --color=auto'
else
  alias ls='ls -G'
fi

alias ll='ls -l'
alias cl='clear'
alias less='less -R'

alias ks='ls'

alias gg='git grep -n'
alias gst='git status'
alias gd='git diff'
alias gl='git log'
alias tl='git log'
alias gch='git checkout'
alias g='git'
alias gv='git --version'
alias gp='git push'
alias gad='git add \.'
alias gc='git commit \-m'
alias gm='branch=$(git remote show origin | grep "HEAD branch" | awk "{print \$NF}"); if [[ "$branch" == "master" || "$branch" == "main" ]]; then git pull origin $branch; else echo "Error: Default branch is neither master nor main"; fi'

alias ggl='git log --graph --pretty=oneline --abbrev-commit --decorate --all'

alias rr='bundle exec rails routes'

alias sz='source ~/.zshrc'

alias v='nvim'
alias i='nvim'
alias iv='nvim'
alias vi='nvim'
alias bi='nvim'
alias vo='nvim'
alias ci='nvim'
alias vz='nvim ~/.zshrc'
alias vv='nvim ~/.config/nvim/init.lua'
alias vk='nvim ~/dotfiles/mac/karabiner.json'
alias nv='nvim'
alias n='nvim'

alias ssh='ssh -o ServerAliveInterval=60'

alias e='nvim'
alias h='history'
alias ha='history-all'
alias cd_dotfiles='cd ~/dotfiles'
alias cd_src='cd ~/src'

# HTMLãƒ•ã‚¡ã‚¤ãƒ«ã«å¼µã‚Šä»˜ã‘ç”¨ã®ã€ã‚¿ãƒ–ã€ç©ºç™½ã€< > ã®å¤‰æ›ã‚³ãƒãƒ³ãƒ‰
alias htmlconv='sed -e "s/</\&lt;/g;s/>/\&gt;/g;s/\t/\&nbsp;\&nbsp;\&nbsp;\&nbsp;/g;s/\s/\&nbsp;/g" '

alias lint='pre-commit run --config ~/dotfiles/pre-commit-config.yml'

# http://qiita.com/yuku_t/items/e58cbecf13407446bd50
function _git_status() {
  if [ "$(git rev-parse --is-inside-work-tree 2> /dev/null)" = 'true' ]; then
    echo git statusb # git statusã‚’å®Ÿè¡Œã—ãŸã£ã½ãã¿ã›ã‹ã‘ã‚‹
    git status
  fi
  zle reset-prompt
}

function _git_diff() {
  if [ "$(git rev-parse --is-inside-work-tree 2> /dev/null)" = 'true' ]; then
    git diff
  fi
  zle reset-prompt
}

function _shell_ls() {
  echo ls
  ls
  zle reset-prompt
}

zle -N git_status _git_status  # _git_statusé–¢æ•°ã‚’git_status widgetã¨ã—ã¦ç™»éŒ²
zle -N git_diff _git_diff
zle -N shell_ls _shell_ls
bindkey '^G^S' git_status
bindkey '^G^G' git_diff
bindkey '^L^S' shell_ls


function t () {
  if [ -z "${1-}" ]; then
    name="s$(date +%s)"  # ã‚»ãƒƒã‚·ãƒ§ãƒ³åãŒé‡è¤‡ã—ãªã„ã‚ˆã†ã«ä¸€æ„ã®åå‰ã‚’ç”Ÿæˆ
  else
    name="$1"
  fi
  tmux new-session -d -s "$name"
  tmux new-window -t "$name"
  tmux new-window -t "$name"
  tmux new-window -t "$name"
  tmux new-window -t "$name"

  tmux select-window -t "$name":0
  tmux attach-session -t "$name"
}

function tt () {
  if [ -n "$1" ]; then
    name="$1"
  else
    name=$(basename "$PWD")
  fi

  if tmux has-session -t "$name" 2>/dev/null; then
    tmux attach-session -t "$name"
  else
    t "$name"
  fi
}

function puma_ps () {
  ROOT_SCREEN_PID=$(ps x | grep -E "S $(echo `basename "$PWD"`)$" | awk '{ print $1}')
  if [[ $ROOT_SCREEN_PID == '' ]]; then
    echo 'ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã®tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'
    exit 1
  else
    pstree -p $ROOT_SCREEN_PID | grep puma
  fi
}

#!/bin/sh
# github.comã§ã‚³ãƒŸãƒƒãƒˆã®URLã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ã§ã™
# Usage: open $(commit_id_url)
# => open browser!!
function commit_id_url() {
  HOST_AND_PATH=$(git remote -v | grep origin | head -n 1 | tr ':' '/' | sed -e 's|.*@\(github.com/[^.]*\)\..*$|\1|')
  HEAD_COMMMIT_ID=$(git rev-parse HEAD)
  echo https://${HOST_AND_PATH}/commit/${HEAD_COMMMIT_ID}
}

function git_file_url() {
  HOST_AND_PATH=$(git remote -v | grep origin | head -n 1 | tr ':' '/' | sed -e 's|.*@\(github.com/[^.]*\)\..*$|\1|')
  HEAD_COMMMIT_ID=$(git rev-parse HEAD)
  echo https://${HOST_AND_PATH}/blob/$HEAD_COMMMIT_ID/$1
}

# test runner for rails
function rt() {
  local filename="$1"  # å¼•æ•°ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åï¼‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã«æ ¼ç´
  if [ $# -gt 0 ]; then
    shift  # æœ€åˆã®å¼•æ•°ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åï¼‰ã‚’ã‚·ãƒ•ãƒˆã—ã¦ã€æ®‹ã‚Šã®å¼•æ•°ã‚’å–å¾—
  fi

  local args="$@"  # æ®‹ã‚Šã®å¼•æ•°ã‚’æ ¼ç´

  # å¼•æ•°ãŒä¸ãˆã‚‰ã‚Œã¦ã„ãªã„å ´åˆã®å‡¦ç†
  if [ -z "$filename" ]; then
    if [ -d "test" ]; then
      echo "Running bundle exec rails test for all test files in the test directory"
      bundle exec rails test $args
    elif [ -d "spec" ]; then
      echo "Running bundle exec rspec for all spec files"
      bundle exec rspec $args
    else
      echo "No test or spec directory found in the current directory"
    fi
  elif [[ "$filename" =~ "_test.rb" ]]; then
    echo "Running bundle exec rails test for $filename"
    bundle exec rails test "$filename" $args
  elif [[ "$filename" =~ "_spec.rb" ]] || [[ "$filename" =~ "spec/" ]]; then
    echo "Running bundle exec rspec for $filename"
    bundle exec rspec "$filename" $args
  elif [[ "$filename" =~ ".feature" ]]; then
    echo "Running cucumber for $filename"
    bundle exec cucumber "$filename" $args
  else
    echo "Unknown file type: $filename"
  fi
}

function retry_command() {
  local max_retries=50
  local OPTIND opt

  while getopts ":n:" opt; do
    case $opt in
      n)
        max_retries=$OPTARG
        ;;
      \?)
        echo "ç„¡åŠ¹ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: -$OPTARG" >&2
        return 1
        ;;
      :)
        echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -$OPTARG ã«ã¯å€¤ãŒå¿…è¦ã§ã™" >&2
        return 1
        ;;
    esac
  done
  shift $((OPTIND -1))

  local command="$@"
  local exit_status=1

  for try in $(seq 1 $max_retries); do
    echo "è©¦è¡Œå›æ•°: $try"
    if eval "$command"; then
      exit_status=0
      echo "ã‚³ãƒãƒ³ãƒ‰ã¯è©¦è¡Œå›æ•° $try ã§æˆåŠŸã—ã¾ã—ãŸ"
      break
    fi

    if [ $try -lt $max_retries ]; then
      sleep 1
    fi
  done

  if [ $exit_status -ne 0 ]; then
    echo "æœ€å¤§è©¦è¡Œå›æ•° $max_retries ã«åˆ°é”ã—ã¾ã—ãŸãŒã€ã‚³ãƒãƒ³ãƒ‰ã¯æˆåŠŸã—ã¾ã›ã‚“ã§ã—ãŸ"
    return 1
  fi

  return 0
}

function whichppr() {
  COMMIT_ID=$1
  if [[ $COMMIT_ID = '' ]]; then
    echo require commit id
    return 1
  fi

  (git show $COMMIT_ID > /dev/null 2>&1 )
  if [[ $? != 0 ]]; then
    echo not found commit id
    return 1
  fi
  PULL_REQUEST_ID=$(git log --merges --oneline --reverse --ancestry-path $COMMIT_ID...master | head -n1 | grep -o -E ' #[^ ]*' | grep -o -E '[0-9]*$')
  if [[ $PULL_REQUEST_ID = '' ]]; then
    echo not found PULL_REQUEST_ID
    return 1
  fi
  REPO_NAME=$(git remote -v | grep origin | head -n1 | grep -o ':[^.]*' | grep -o '[^:]*$')
  BASE=https://github.com
  open "$BASE/$REPO_NAME/pull/$PULL_REQUEST_ID"
}

function d() {
  yt-dlp "$1" &
}


# NOTE: benchmark disk write speed
bdr() {
  if [[ -z "$1" ]]; then
    echo "Usage: bdr <output_file>"
    return 1
  fi

  local output_file="$1"
  local bs="1m"
  local count="10000"
  local oflag="direct"

  echo "Writing zeros to $output_file..."
  dd if=/dev/zero of="$output_file" bs="$bs" count="$count" oflag="$oflag" status=progress
}

source $HOME/dotfiles/zshlib/_av1ify.zsh
source $HOME/dotfiles/zshlib/_repair.zsh
source $HOME/dotfiles/zshlib/_concat.zsh

function rrr() {
  local inputfile="$1"
  if [[ ! -f "$inputfile" ]]; then
    echo "Error: File not found - $inputfile" >&2
    return 1
  fi
  local dir="${inputfile:h}"
  local basename="${inputfile:t}"
  local tmpfile="${dir}/.${basename}.mp4.tmp"

  if ffmpeg -i "$inputfile" -c copy -tag:v hvc1 -movflags +faststart -f mp4 "$tmpfile"; then
    mv "$tmpfile" "$inputfile"
    echo "Repacked and replaced: $inputfile"
  else
    echo "Error: ffmpeg failed for $inputfile" >&2
    rm -f "$tmpfile"
    return 1
  fi
}

source $HOME/dotfiles/zshlib/_ensure_cli_with_brew.zsh

# AI CLIã‚³ãƒãƒ³ãƒ‰ã®tmuxãƒ©ãƒƒãƒ‘ãƒ¼å…±é€šé–¢æ•°
function _wrap_ai_command_with_tmux() {
  local cmd_name="$1"
  local brew_formula="${2:-$cmd_name}"
  shift 2

  # Homebrewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ä¿è¨¼ï¼ˆclaudeä»¥å¤–ï¼‰
  if [[ "$cmd_name" != "claude" ]]; then
    _ensure_cli_with_brew "$cmd_name" "$brew_formula" || return 1
  fi

  if [ -n "$TMUX" ]; then
    # tmux pane ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ•°ã«ã‚³ãƒãƒ³ãƒ‰åã‚’å…¥ã‚Œã¦è‡ªå‹•ãƒªãƒãƒ¼ãƒ ã§æ‹¾ã‚ã›ã‚‹
    tmux set-option -pqu @ai_name 2>/dev/null
    tmux set-option -pq  @ai_name "ğŸ¤– $cmd_name" 2>/dev/null
  fi

  command "$cmd_name" "$@"
  local exit_code=$?

  if [ -n "$TMUX" ]; then
    # å¾Œç‰‡ä»˜ã‘
    tmux set-option -pqu @ai_name 2>/dev/null
  fi

  return $exit_code
}

# ğŸ¤– claudeã‚³ãƒãƒ³ãƒ‰ã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•° - tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åã‚’è‡ªå‹•è¨­å®š
function claude() {
  _wrap_ai_command_with_tmux claude claude-code "$@"
}

# ğŸ¤– geminiã‚³ãƒãƒ³ãƒ‰ã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•° - tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åã‚’è‡ªå‹•è¨­å®š
function gemini() {
  _wrap_ai_command_with_tmux gemini gemini-cli "$@"
}

# ğŸ¤– codexã‚³ãƒãƒ³ãƒ‰ã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•° - tmuxã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åã‚’è‡ªå‹•è¨­å®š
function codex() {
  _wrap_ai_command_with_tmux codex codex --search "$@"
}

if [[ -n "$SSH_AUTH_SOCK" ]] && ! ssh-add -l > /dev/null 2>&1; then
  ssh-add ~/.ssh/id_rsa > /dev/null 2>&1
fi

if [ -f ~/.fzf.zsh ]; then
  source ~/.fzf.zsh
elif [ -f /opt/homebrew/opt/fzf/shell/key-bindings.zsh ]; then
  source /opt/homebrew/opt/fzf/shell/key-bindings.zsh
fi
if [[ -o interactive ]] && ! (( $+functions[fzf-history-widget] )); then
  fzf-history-widget() {
    zle history-incremental-search-backward -- "$@"
  }
  zle -N fzf-history-widget
fi
if (( $+functions[fzf-history-widget] )); then
  bindkey -M emacs '^R' fzf-history-widget
  bindkey -M vicmd '^R' fzf-history-widget 2>/dev/null
fi

if command -v brew > /dev/null 2>&1; then
  brew_prefix="$(brew --prefix)"

  if [ -f "$brew_prefix/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ]; then
    source "$brew_prefix/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
  fi

  if [ -f "$brew_prefix/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]; then
    source "$brew_prefix/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
  fi
fi

# Ignore commands starting with space from history
setopt HIST_IGNORE_SPACE
