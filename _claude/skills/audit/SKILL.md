---
name: audit
version: 1.0.0
description: プロジェクト監査。設計/UX/品質/テストなどの観点でコードベースを監査し、課題をissuesディレクトリに書き出す。実行ログで重複実行を防止。
disable-model-invocation: true
---

# Audit

プロジェクト監査オーケストレーター。以下の手順に従って監査を実行してください。

## Step 1: 実行ログの確認

`issues/audit-log` ファイルを読み取ってください（存在しない場合はスキップ）。
このログには過去の監査実行記録が含まれています。

## Step 2: 監査タイプの選択

以下の監査タイプ一覧をユーザーに提示してください。
ログに直近7日以内の実行記録がある場合、該当タイプに `(最終: MM/DD)` を付記してください。

### 監査タイプ一覧

| ID | カテゴリ | 名前 | 説明 |
|----|----------|------|------|
| design | 設計 | 設計改善 | 今後問題になりうる設計上の課題を探す |
| ux | UX | UX改善 | UX的に劣っている箇所を探す |
| issues-done | 管理 | 完了issue確認 | issues/done の中を確認し、完了済みのものを移動する |
| resource-leaks | 品質 | リソースリーク | リソースリークの可能性が高いコードを探す |
| responsibility | 設計 | 責務集中 | 責務が集中しているクラス/モジュールを探す |
| lint-from-done | 改善 | lint転用調査 | issues/done から lint ルールに転用できるパターンを探す |
| broken-code | 品質 | 壊れたコード | コードベースの破損や設計的破綻を探す |
| test-cleanup | テスト | 無意味テスト削除 | 意味のないテストコードを探して削除する |
| test-helpers | テスト | テストヘルパー共通化 | 繰り返し使われているテストヘルパーを共通化する |
| general | 総合 | 総合課題発見 | カテゴリを問わず問題になりうる課題を探す |

### 選択方法

AskUserQuestion は最大4選択肢のため、カテゴリ別に2段階で選択させてください。

**1問目**: カテゴリを選択（multiSelect: true）
- 設計 (design, responsibility)
- 品質 (resource-leaks, broken-code)
- テスト (test-cleanup, test-helpers)
- その他 (ux, issues-done, lint-from-done, general)

**2問目以降**: 選択されたカテゴリ内の具体的なタイプを選択（multiSelect: true）。
以下のルールに従ってください:
- カテゴリ内のタイプが1つしかない場合は自動選択してこの質問をスキップ
- 候補が合計4つ以下の場合はまとめて1問で提示
- 候補が合計5つ以上の場合はカテゴリごとに分割して質問（各質問は最大4選択肢）

## Step 3: 実行モードの選択

`~/.claude/skills/forge/_common/modes.md` を読み取り、「モード一覧」テーブルから利用可能なモード名・説明を取得してください。
このファイルが存在しない場合はプロジェクトローカルの `_claude/skills/forge/_common/modes.md` を試してください。
両方存在しない場合は forge が未導入のため、自動的に「直接実行」を選択し、以下の選択をスキップしてください。

取得したモード一覧 + 直接実行を以下のように2段階で選択させてください。

**1問目**: 実行方式を選択
- forge（forge スキル経由で実行）
- 直接実行（forge を使わず直接タスクを実行する）

**2問目**（forge 選択時のみ）: modes.md から読み取ったモード名を最大4つ提示して選択させてください。

## Step 4: 監査の実行

選択された監査タイプと実行モードに基づいて監査を実行します。

### forge モードが選択された場合

`/forge` スキルを呼び出して以下のプロンプトを実行してください。
ユーザーが選択したモードを明示的に指定してください。

各監査タイプのプロンプト:

- **design**: `[モード名]モードで実行して。今後問題になりうる、設計系に改善するべき実装を探してissuesディレクトリに書き出して`
- **ux**: `[モード名]モードで実行して。UX的に劣っている箇所を探してissuesディレクトリに書き出して`
- **issues-done**: `[モード名]モードで実行して。issuesディレクトリで未着手のissueを一通り確認して完了しているものがそのように修正してdoneに移動して`
- **resource-leaks**: `[モード名]モードで実行して。リソースリークしている可能性の高いコードを探してissuesディレクトリに書き出して`
- **responsibility**: `[モード名]モードで実行して。責務が集中しているクラスを探してissuesディレクトリに書き出して`
- **lint-from-done**: `[モード名]モードで実行して。issues/doneの中身を確認して、lintに転用すると有用そうなことがないかを調べてissuesディレクトリに書き出して`
- **broken-code**: `[モード名]モードで実行して。コードベースを見て壊れている箇所がないか、設計的に破綻している箇所がないか調べて`
- **test-cleanup**: `[モード名]モードで実行して。テストコードのうち、意味のないテストになっているコードを探して削除して`
- **test-helpers**: `[モード名]モードで実行して。テストコードのうち、繰り返し使っているヘルパーを見つけて共通化して`
- **general**: `[モード名]モードで実行して。プロジェクトを眺めて、設計とかUXとかカテゴリなんでもいいので、問題になりうる課題を探してissuesディレクトリに書き出して`

### 直接実行 (not forge) が選択された場合

forge を使わず、あなた自身が直接タスクを実行してください。
Explore エージェントでコードベースを調査し、発見事項を issues ディレクトリに書き出してください。
出力フォーマットは既存の issues ファイル（例: issues/nvim-config-improvements.md）に合わせてください。

各監査タイプの調査指針:

- **design**: アーキテクチャ全体を俯瞰し、密結合・循環依存・レイヤー違反・拡張困難な箇所を探す
- **ux**: ユーザー操作フロー・エラーメッセージ・レスポンス速度・一貫性の観点で劣っている箇所を探す
- **issues-done**: issues/done 内のファイルを読み、実装済みかどうかをコードベースと照合して確認する
- **resource-leaks**: ファイルハンドル・DB接続・イベントリスナー・タイマーなど、解放漏れの可能性がある箇所を探す
- **responsibility**: クラスやモジュールの行数・メソッド数・依存数を確認し、責務が過度に集中している箇所を探す
- **lint-from-done**: issues/done のパターンを分析し、lint ルールとして自動検出できそうな再発防止策を探す
- **broken-code**: 到達不能コード・型不整合・未使用の引数・壊れたインポートなど、実行時エラーになりうる箇所を探す
- **test-cleanup**: 常に pass するアサーション・重複テスト・実装と乖離したモックなど、価値のないテストを探す
- **test-helpers**: 複数テストファイルで繰り返されているセットアップやユーティリティを特定し、共通ヘルパーへの抽出を提案する
- **general**: 上記すべての観点を広く浅くカバーし、最も影響が大きい課題を優先して報告する

## Step 5: commit と実行ログの記録

### commit

監査完了後、発見事項を issues ディレクトリに書き出した場合は git commit してください。

### 実行ログの記録

`issues/audit-log` に以下の形式で追記してください。
ファイルが存在しない場合は新規作成してください。

```
YYYY-MM-DD HH:MM	<audit-type-id>	<mode>	<output-files>
```

フィールドはタブ区切りです。例:
```
2026-02-15 14:30	design	forge-standard	issues/design-improvements.md
2026-02-15 14:45	broken-code	direct	issues/broken-code-findings.md
2026-02-15 15:00	general	forge-minimum+	issues/general-issues.md
```

複数の監査タイプが選択された場合は、各タイプを順番に実行し、それぞれログを記録してください。
実行中にエラーが発生した場合は、そのタイプのログに `error` と記録し、次のタイプに進んでください。
すべてのタイプの実行が完了（またはエラー）した後、エラーがあった場合はユーザーに報告してください。
audit-log 自体も commit に含めてください。

## 注意事項

- issues ディレクトリが存在しない場合は作成してください
- 出力ファイル名は `issues/<audit-type-id>-<簡潔な説明>.md` としてください
- 既存の issue ファイルと同じカテゴリの場合、既存ファイルへの追記も検討してください
