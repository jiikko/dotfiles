# Phase 2〜3: 実装・セルフレビュー

## Phase 2: 実装 + ビルド確認（実装モードのみ）

Phase 1 の調査結果と Phase 1.5 の設計書に基づき、実装を行う。

### 実装手順

1. **類似コードを開く**: Explore で特定した類似コードを Read で読み込む
2. **パターンを踏襲**: 類似コードの命名規則、構造、エラーハンドリングを参考にする
3. **段階的に実装**: 設計書のステップに従って順番に実装
4. **都度ビルド確認**: 変更後は `make build` で即座に確認

### 実装時のチェックリスト

```markdown
□ CLAUDE.md のルールに準拠
  - 強制アンラップ禁止
  - canvases[0] 等の直接アクセス禁止
  - @State は private
  - メインスレッド制約を遵守

□ 類似コードとの一貫性
  - 命名規則を合わせる
  - ファイル配置を合わせる
  - エラーハンドリング方式を合わせる

□ モデル変更時の追加タスク（該当する場合）
  - ラウンドトリップテストの更新
  - docs/elements.md の更新
  - docs/api-design.md の更新
```

### ビルド確認（必須）

```bash
# 実装後、必ず実行
make build
```

**ビルドが失敗した場合**: エラーを修正してから次に進む。ビルドが通らない状態で Phase 3 に進まない。

### 実装中の専門家相談（難所で活用）

| 詰まった内容 | 呼び出すエージェント |
|-------------|---------------------|
| actor/async の設計 | swift-concurrency-expert |
| View の再描画問題 | swiftui-performance-expert |
| 設計・責務分離の判断 | architecture-reviewer |
| AppKit 統合の問題 | appkit-swiftui-integration-expert |
| テストの書き方 | swiftui-test-expert |
| エラーの原因特定 | debugger |

---

## Phase 3: セルフレビュー（実装モードのみ）

実装完了後、以下の観点でセルフレビューを実施する（回数はモード設定に従う）。

---

### 重要度定義

| 重要度 | 基準 | 対応 |
|--------|------|------|
| **BLOCKER** | CLAUDE.md 違反、ビルド失敗、テスト失敗 | 即時修正必須。修正後、同じレビューを再実施 |
| **WARNING** | 品質懸念、軽微な一貫性違反 | 記録して Phase 4 へ持ち越し可 |
| **INFO** | 改善提案レベル | 記録のみ。Phase 4 後に検討 |

---

### セルフレビュー 1回目: 要件充足

| チェック項目 | 合格基準 | 不合格例 |
|-------------|---------|---------|
| Phase 0 で確認した要件をすべて満たしているか | 要件リストの全項目に対応するコードが存在 | 要件の一部が未実装 |
| 設計書の「期待される結果」を達成しているか | 設計書記載の期待動作が再現可能 | 期待動作の一部が未実現 |
| エッジケースを考慮しているか | 設計書の「リスク・懸念点」を全て処理 | 空配列、nil、境界値が未処理 |

**判定**: 各要件に対して「実装箇所: `filepath:line`」を特定できれば合格

---

### セルフレビュー 2回目: 正確性

| チェック項目 | 合格基準 | 検証方法 |
|-------------|---------|---------|
| ロジックは正しいか | 条件分岐が要件通りに動作 | 各分岐パスを手動トレース |
| エラーハンドリングは適切か | 全 `throws`/`Result.failure` に対応処理あり | `catch`/`.failure` ブロックを列挙 |
| nil/optional の扱いは安全か | `!` 強制アンラップなし | 下記パターンを Grep で検索 |

**強制アンラップ検出パターン**:
```
検出すべきパターン:
- `\w+!` (変数の強制アンラップ: foo!)
- `try!` (強制 try)
- `as!` (強制キャスト)
- `\.first!` / `\.last!` (配列要素の強制アンラップ)

許容パターン（文脈により OK）:
- `@IBOutlet` や Storyboard 関連
- テストコード内の固定データセットアップ
```
| 境界値は正しく処理されているか | 0, 空, 最大値でクラッシュしない | 該当値でメンタルテスト |

**BLOCKER 条件**:
- `!` 強制アンラップが存在（CLAUDE.md 違反）
- `[0]`, `[n]` の配列直接アクセスが存在（CLAUDE.md 違反）

---

### セルフレビュー 3回目: 類似コードとの一貫性

| チェック項目 | 合格基準 | 検証方法 |
|-------------|---------|---------|
| Phase 1 で特定した類似コードと同じパターンを使っているか | 構造（メソッドシグネチャ、エラー処理）を踏襲 | 類似コードと並べて目視比較 |
| 命名規則は既存コードと一致しているか | 同種要素で同じ命名パターン | 既存ファイル名と比較 |
| ファイル配置は適切か | 同種ファイルと同じディレクトリ | `ls` で確認 |

**WARNING 例**: 命名が微妙に異なる（`userId` vs 既存 `userID`）

---

### セルフレビュー 4回目: 品質

| チェック項目 | 合格基準 | 検証方法 |
|-------------|---------|---------|
| コードは読みやすいか | 1メソッド50行以内、ネスト3段以内 | 各メソッドの行数・深度確認 |
| 重複コードはないか | 3行以上の同一ブロックが2箇所以上にない | 新規コードを Grep |
| 単一責任原則を守っているか | 1クラス/構造体が1責務のみ | メソッドの抽象度が統一 |
| 過剰な実装（YAGNI違反）はないか | 要件にない機能がない | 各メソッドが要件に紐付く |

**WARNING 例**: メソッドが60行（機能は正しいが長い）

---

### セルフレビュー 5回目: プロジェクトルール + ビルド・テスト

| チェック項目 | 合格基準 | 検証方法 |
|-------------|---------|---------|
| CLAUDE.md のルールに違反していないか | 全禁止パターンに該当なし | チェックリストを順に確認 |
| SwiftLint エラー/警告はないか | `make lint` が exit 0 | コマンド実行 |

**必須コマンド実行と合格基準**:

| コマンド | 合格基準 | 重要度 |
|---------|---------|--------|
| `make lint` | exit 0、エラー 0 件 | BLOCKER |
| `make build` | exit 0 | BLOCKER |
| `make test` | exit 0、全テストパス | BLOCKER |

**テスト失敗時の対応**:

| 失敗パターン | 対応 | 相談先 |
|-------------|------|-------|
| アサーション失敗 | ロジック修正 | - |
| タイムアウト/ハング | Task.detached/MainActor 確認 | swiftui-test-expert |
| ビルドエラー | Phase 2 に戻る | - |
| 不定期失敗（Flaky） | 並行処理/競合状態確認 | swift-concurrency-expert |

---

### Phase 4 進行基準

以下を**すべて**満たす場合のみ Phase 4 に進行可能:

1. **BLOCKER が 0 件**
2. `make lint` が exit 0
3. `make build` が成功
4. `make test` が全パス

**WARNING は持ち越し可能**: Phase 4 で専門家に判断を委ねる（上限 5 件。超過時は Phase 4 前に対応を検討）

---

### 不合格時の対応フロー

```
セルフレビュー N
      │
   全項目合格?
      │
   YES │ NO
      │   │
      ▼   ▼
次のレビュー  問題の重要度判定
(N+1) へ         │
              ┌──┴──┐
          BLOCKER  WARNING
              │       │
              ▼       ▼
          即時修正   記録して
              │    次へ進む
              ▼
          同じレビュー N を再実施
```

**ルール**:
- BLOCKER を修正した場合: その回のセルフレビューを最初から再実施
- 同じ BLOCKER が 3 回連続: 専門家相談フローへ
- 修正ループ 5 回超過: 強制的に専門家相談

---

### 専門家相談フロー

| 問題カテゴリ | 相談先エージェント |
|-------------|-------------------|
| ロジック/アルゴリズム | swift-language-expert |
| メモリ/パフォーマンス | swiftui-performance-expert |
| 設計/責務分離 | architecture-reviewer |
| テスト/カバレッジ | swiftui-test-expert |
| 既存コード整合性 | Explore |
| actor/async | swift-concurrency-expert |
| 原因不明エラー | debugger |

**相談プロンプト**:
```
Phase 3 セルフレビュー中に判定困難な問題が発生しました。

問題カテゴリ: [カテゴリ]
チェック項目: [項目名]
該当コード: [コードスニペット]
迷っている点: [選択肢A/B]

以下を回答してください:
1. この問題は BLOCKER / WARNING / INFO のいずれか
2. 推奨される対応
3. 判断の根拠
```

---

## Phase 3.5: スキル自動検証（VALIDATION）

> **Minimum モード**: このフェーズは省略
> **詳細**: @_common/skill-triggers.md を参照

Phase 3 完了後、`skill-triggers.md` のトリガーレジストリに基づき、**VALIDATION カテゴリ**のスキルを自動実行する。

### 実行条件

1. Phase 3 セルフレビュー完了（BLOCKER 0 件）
2. `applicable_skills`（Phase 0 で特定済み）に VALIDATION スキルが存在
3. モードが Standard 以上

### 実行手順

1. Phase 2 で変更されたファイルから、該当スキルの対象ファイルを特定
2. 該当スキルの SKILL.md に定義されたフローを実行（Task ツール使用）
3. 結果を解析し、High/Medium/Low を分類

### 結果の扱い

| スキル結果 | 対応 |
|-----------|------|
| **High あり** | BLOCKER 扱い → Phase 2 に戻って修正 |
| **Medium/Low のみ** | 記録して Phase 4 へ進行。結果をエージェントコンテキストに含める |
| **問題なし** | Phase 4 へ進行 |

### 例: style-review の自動実行

CSS/SCSS ファイルが変更対象に含まれる場合:

```
1. Glob で変更対象の *.css, *.scss, *.module.css を特定
2. style-review SKILL.md の「css-expert 指示テンプレート」を使用
3. css-expert エージェントを Task ツールで起動
4. WCAG コントラスト比、フォーカス状態、モーション設定を検証
5. High（AA 違反）あり → Phase 2 に戻る
6. High なし → 結果を記録して Phase 4 へ
```
