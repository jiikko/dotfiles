# Phase 4.5〜5: デバッグ・収束・完了

## Phase 4.5: デバッグ支援（エラー発生時）

レビューで**ランタイムエラーやクラッシュ**が報告された場合、debugger エージェントを起動する。

### 起動条件

- テスト実行時にエラーが発生
- ビルドは通るが実行時にクラッシュ
- 原因不明の挙動

### debugger プロンプト

```
以下のエラーを調査してください。

エラー内容:
[エラーメッセージ/スタックトレース]

発生箇所:
[ファイル:行番号]

再現手順:
[手順]

関連する変更:
[今回の変更内容]

根本原因を特定し、修正案を提案してください。
```

### クラッシュログの確認

macOS アプリがクラッシュした場合:
```bash
ls ~/Library/Logs/DiagnosticReports/ | grep -i thumbnail
cat ~/Library/Logs/DiagnosticReports/ThumbnailThumb-*.ips | head -200
```

---

## Phase 5: 修正と収束（両モード共通）

### 対話フロー

レビュー結果を報告した後、AskUserQuestion ツールで対応方針を確認：

```
質問: 「レビュー結果に基づいて、どのように対応しますか？」

選択肢:
1. 高優先度の指摘をすべて修正する
2. 指摘ごとに個別に確認する
3. 今回は修正しない（レポートのみ）
4. Issue を作成して後で対応する
```

### 修正後の確認（必須）

```bash
make lint   # SwiftLint チェック
make build  # ビルド確認
make test   # テスト実行（リグレッション確認）
```

**すべて通過してから**再レビューに進む。

### 収束条件

- 全エージェントから「指摘なし」が返ってきたら完了
- または、残りの指摘がすべて「スキップ」または「Issue として記録」された場合

### 最大サイクル数

**5サイクル**を上限とする。5サイクルでも収束しない場合:

```
質問: 「5サイクル実行しましたが、以下の指摘が残っています。どう対応しますか？」

選択肢:
1. 継続する（さらに5サイクル）
2. 残りの指摘を Issue として記録し、完了とする
3. 中断する
```

### 矛盾する指摘への対応

Phase 4.2 の「矛盾の解決」ルールに従う。

---

## 連携機能

### DIAGNOSTIC スキル連携（Phase 4.5+）

> **詳細**: @_common/skill-triggers.md の「Phase 4.5+」セクションを参照

Phase 4 の統合結果に `performance` カテゴリの High 指摘が含まれる場合、`perf-analysis` の自動実行を提案:

```
質問: 「パフォーマンス問題が検出されました。perf-analysis を実行しますか？」

選択肢:
1. 実行する
2. Issue として記録し、後で対応
3. スキップ
```

### test-runner 連携

テスト追加が推奨された場合、レビュー完了後に test-runner エージェントを起動：

1. swiftui-test-expert の結果から「テスト追加推奨」の項目を抽出
2. ユーザーに確認: 「テストを追加・実行しますか？」
3. 承諾された場合: test-runner でテスト実行

### Issue 作成

重要な問題点が見つかった場合、`issues/` ディレクトリへの記録を提案。

### Issue の完了処理

対応した issue の全項目が完了した場合、issue ファイルに対応状況（修正内容・日付等）を記載した上で `issues/done/` に移動する。

---

## Phase 5.5: スキルテスト（TESTING）

> **Minimum/Standard モード**: このフェーズは省略
> **詳細**: @_common/skill-triggers.md の「Phase 5.5」セクションを参照

Phase 5 の修正が収束した後、**TESTING カテゴリ**のスキルを実行する。

### 実行条件

1. Phase 5 の修正が収束済み
2. `applicable_skills`（Phase 0 で特定済み）に TESTING スキルが存在
3. モードが Maximum 以上

### 実行手順

1. AskUserQuestion でテスト実行を確認:

```
質問: 「以下のスキルテストを実行しますか？」

選択肢:
1. すべて実行
2. 選択して実行
3. スキップ

該当スキル:
- smoke-test: アプリ全体の動作確認
- ios-simulator-skill: iOS シミュレーターでのテスト
```

2. 承認されたスキルのフローを実行
3. 結果を完了レポートに追加
4. **失敗時**: Phase 5 に戻り、修正サイクルを再開

---

## 完了レポート

```markdown
## Forge 完了レポート

### 対象
[タスク説明 or ファイル/ディレクトリ]

### モード
[実装 / レビュー]

### 実施サイクル数
[N] サイクル

### 参考にした類似コード
- [ファイル:行番号]: [何を参考にしたか]

### 変更ファイル
- [ファイルパス]: [変更概要]

### 修正した指摘
- [指摘1]: [修正内容]

### スキップした指摘
- [指摘]: [理由]

### Issue として記録
- [Issue番号]: [指摘内容]

### 最終確認
- [ ] make lint 通過
- [ ] make build 通過
- [ ] make test 通過
- [ ] ドキュメント更新（該当する場合）
```
