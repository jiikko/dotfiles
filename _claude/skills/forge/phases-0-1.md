# Phase 0〜1.5: 要件確認・事前調査・設計

## Phase 0: 要件確認（実装モードのみ）

実装前に、AskUserQuestion ツールで要件を明確化する。

### 確認項目

```
質問: 「以下の要件で正しいですか？」

タスク: [ユーザーの入力]

確認事項:
1. 目的: [推測した目的]
2. スコープ: [影響範囲の推測]
3. 期待する動作: [具体的な動作]
4. 制約: [あれば]

選択肢:
1. はい、この要件で進めてください
2. 要件を修正したい（詳細を入力）
3. 不明点があるので質問したい
```

### 要件が曖昧な場合

以下のパターンでは**必ず確認**する:

| 曖昧なパターン | 確認すべき内容 |
|---------------|---------------|
| 「〜を追加」 | どこに？どんな形式で？ |
| 「〜を改善」 | 具体的に何を？どの程度？ |
| 「〜のバグを修正」 | 再現手順は？期待動作は？ |
| 「〜を最適化」 | 何を基準に？許容範囲は？ |

---

## Phase 1: 事前調査 + 類似コード特定（実装モードのみ）

最低6つの専門家エージェントを**並行起動**し、実装に必要な情報を収集する。

> **Minimum モードの場合**: 3エージェントのみを**直列実行**する。
> **Maximum Sequential モードの場合**: 全エージェントを**直列実行**する。

### 必須エージェント（6つ）

```
1. swift-language-expert (model: opus)
   prompt: "以下のタスクを実装するために必要な Swift 言語の知識を調査してください。
   - 関連する言語機能（async/await, actor, protocol 等）
   - メモリ管理の考慮点
   - エラーハンドリングパターン
   タスク: [タスク説明]
   既存コードベースの関連部分も確認し、実装方針を提案してください。"

2. swiftui-macos-designer (model: opus)
   prompt: "以下のタスクを実装するために必要な SwiftUI/macOS の知識を調査してください。
   - 関連する View/State パターン
   - 既存の UI コンポーネントとの整合性
   - macOS HIG への準拠
   タスク: [タスク説明]
   既存の View 構造を確認し、実装方針を提案してください。"

3. research-assistant (model: opus)
   prompt: "以下のタスクに関するベストプラクティスと公式ドキュメントを**徹底調査**してください。
   - Apple 公式ドキュメント
   - 推奨される実装パターン
   - 一般的な落とし穴と回避策
   - **複数ソースのクロスチェック**
   - **反論や代替案の検討**
   タスク: [タスク説明]
   参考リンクと共に、**信頼性評価を含めて**報告してください。"

4. Explore (model: opus) ★類似コード特定強化
   prompt: "以下のタスクに関連する既存コードを**徹底的に**調査してください。

   【必須】類似機能の特定:
   - 同様の機能を持つ既存コードを特定
   - そのコードの実装パターンを詳細に報告
   - 再利用可能な部分を明示

   【必須】影響範囲:
   - 変更が必要なファイル一覧
   - 依存関係のあるファイル
   - 既存テストへの影響

   タスク: [タスク説明]

   **重要**: 類似コードが見つかった場合、そのファイルパスと該当行番号を
   必ず報告してください。実装時にそのパターンを参考にします。"

5. architecture-reviewer (model: opus)
   prompt: "以下のタスクのアーキテクチャ観点での設計方針を提案してください。
   - 適切なレイヤー配置（View/ViewModel/Model/Service）
   - 依存方向の確認
   - 責務分離の妥当性
   - テスタビリティ
   タスク: [タスク説明]
   既存アーキテクチャとの整合性を確認し、推奨する設計を報告してください。"

6. swiftui-test-expert (model: opus)
   prompt: "以下のタスクのテスト戦略を**徹底的に**提案してください。
   - 必要なユニットテスト
   - リグレッションテスト（既存機能の保護）
   - **エッジケースの網羅的な検討**
   - **非同期処理のテストパターン**
   - **潜在的なフレーキーテストのリスク分析**
   タスク: [タスク説明]
   既存テストとの整合性も確認してください。"
```

### 条件付き必須エージェント

| 条件 | 追加エージェント | モデル |
|------|-----------------|--------|
| View/UI 変更を含む | swiftui-performance-expert | opus |
| async/await, actor, Task を含む | swift-concurrency-expert | opus |
| ファイル操作、外部入力、API 通信 | security-auditor | opus |

### 追加エージェント（タスク内容に応じて選択）

| タスク内容 | 追加エージェント | モデル |
|-----------|-----------------|--------|
| AppKit 連携あり | appkit-swiftui-integration-expert | opus |
| データ保存あり | data-persistence-expert | opus |
| システム API 使用 | macos-system-integration-expert | opus |
| UI エディタ関連 | image-editing-expert | opus |

### 言語別エージェント（プロジェクト検出時に自動追加）

| 検出条件 | 追加エージェント | 代替する必須エージェント |
|---------|-----------------|----------------------|
| `.go`, `go.mod` | go-architecture-designer | swift-language-expert |
| `.rb`, `Gemfile`, Rails | rails-domain-designer | swift-language-expert, swiftui-macos-designer |
| `.css`, `.scss`, CSS-in-JS | css-expert | swiftui-macos-designer |
| `.js`, `.ts`, `package.json` | nodejs-expert | swift-language-expert |
| `electron`, `BrowserWindow` | electron-expert | (追加) |

**注意**: 非 Swift プロジェクトでは、必須エージェント #1-2 を上記の言語別エージェントに置き換える。

### Maximum 専用エージェント（Phase 1）

Maximum モード選択時は、以下のエージェントを**必ず追加で並行起動**する：

```
7. dependency-analyzer (model: opus)
   prompt: "以下のタスクの影響範囲を分析してください。
   - 変更対象ファイルの依存関係マッピング
   - 変更による波及効果の予測
   - 循環依存の有無
   - 影響を受けるテストファイルの特定
   タスク: [タスク説明]
   影響範囲レポートを作成してください。"

8. test-coverage-advisor (model: opus)
   prompt: "以下のタスクのテストカバレッジ状況を分析してください。
   - 既存テストのカバレッジ評価
   - テストギャップの特定
   - リファクタリング前に追加すべきテスト
   - リグレッション防止戦略
   タスク: [タスク説明]
   テスト戦略レポートを作成してください。"

9. refactoring-patterns (model: opus) ★リファクタ系タスクのみ
   条件: タスクが「リファクタ」「分割」「抽出」「移動」「整理」を含む場合
   prompt: "以下のリファクタリングタスクの安全な実行手順を設計してください。
   - 適用すべきリファクタリングパターンの選定
   - 段階的な実行ステップ
   - 各ステップのロールバック方法
   - 破壊的変更の回避策
   タスク: [タスク説明]
   リファクタリング計画を作成してください。"
```

---

## Phase 1.1: クロスレビュー（実装モードのみ）

Phase 1 の各エージェント出力を、**別の観点を持つエージェントが検証**する。

### クロスレビューのペアリング

| 元エージェント | レビュー担当 | 代替（不在時） | 検証観点 |
|---------------|-------------|--------------|---------|
| swift-language-expert | architecture-reviewer | - | 言語機能の選択が設計に適合しているか |
| swiftui-macos-designer | swiftui-performance-expert | architecture-reviewer | UI 設計がパフォーマンスに影響しないか |
| architecture-reviewer | swift-language-expert | - | 設計が Swift の言語機能を活かしているか |
| swiftui-test-expert | Explore | - | テスト戦略が既存パターンと整合しているか |
| Explore | swiftui-test-expert | - | 特定した類似コードのテストカバレッジは十分か |
| research-assistant | security-auditor | swift-language-expert | 調査したベストプラクティスにセキュリティ懸念はないか |

### クロスレビュー プロンプト

```
以下は [元エージェント名] の調査結果です。
[観点] の観点から検証し、以下を報告してください。

検証対象:
[元エージェントの出力全文]

検証項目:
1. 事実の正確性: 記載内容に誤りはないか
2. 見落とし: 重要な考慮点が漏れていないか
3. リスク: 提案された方針に潜在的なリスクはないか
4. 補足: 追加で考慮すべき点はあるか

出力形式:
- ✅ 検証OK: [問題なしの項目]
- ⚠️ 要注意: [注意が必要な項目と理由]
- ❌ 要修正: [修正が必要な項目と修正案]
- 💡 補足: [追加の考慮点]
```

### 統合エージェントによる結果統合

クロスレビュー完了後、**統合エージェント**を起動して結果を統合:

```
統合エージェント プロンプト:

以下は Phase 1 の調査結果と、それぞれのクロスレビュー結果です。
これらを統合し、メイン Claude に報告するための最終結果を作成してください。

【統合対象】
[各エージェントの出力 + クロスレビュー結果]

【統合ルール】
1. 重複する情報を排除
2. 矛盾がある場合は両方の見解を記載し、推奨を明示
3. ⚠️ 要注意 と ❌ 要修正 の項目を優先的に報告
4. 各情報の出典（エージェント名）を保持

【出力形式】
## 統合済み調査結果

### 1. 実装方針（合意済み）
[全エージェントが合意した方針]

### 2. 要注意事項
[クロスレビューで指摘された注意点]

### 3. 参考にする類似コード
[Explore + クロスレビューで検証済み]

### 4. 未解決の矛盾
[エージェント間で見解が分かれた点]
```

---

## Phase 1.5: 設計書作成・ユーザー承認（実装モードのみ）

調査結果を元に設計書を作成し、実装前にユーザーの承認を得る。

### 設計書フォーマット

```markdown
## 設計書: [タスク名]

### 1. 概要
[タスクの目的と期待される結果]

### 2. 参考にする類似コード
| ファイル | 行番号 | 参考ポイント |
|---------|--------|-------------|
| [パス] | [N-M行] | [何を参考にするか] |

### 3. 変更ファイル一覧
| ファイル | 変更内容 | 新規/修正 |
|---------|---------|----------|
| [パス] | [概要] | 新規/修正 |

### 4. 実装方針
1. [ステップ1]
2. [ステップ2]
...

### 5. テスト方針
- [ ] [テスト1]
- [ ] [テスト2]

### 6. リスク・懸念点
- [あれば記載]
```

### ユーザー承認

```
質問: 「この設計で実装を進めてよいですか？」

選択肢:
1. はい、この設計で進めてください
2. 設計を修正したい
3. 追加の調査が必要
4. キャンセル
```
