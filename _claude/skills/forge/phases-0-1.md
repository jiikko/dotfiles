# Phase 0〜1.5: 要件確認・事前調査・設計

> **適用条件**: 実装モードが選択された場合のみ実行
> **流れ**: Phase -1（モード選択）→ このフェーズ → Phase 2-3 → Phase 4
> **注意**: Phase -1（モード選択）は SKILL.md を参照
> **重要**: このファイル内の `@_common/` 参照は自動解決されません。SKILL.md の「共通ファイルの読み込み」セクションに従って、事前に Read してください。

## Phase 0: 要件確認（実装モードのみ）

実装前に、AskUserQuestion ツールで要件を明確化する。

### 確認項目

```
質問: 「以下の要件で正しいですか？」

タスク: [ユーザーの入力]

確認事項:
1. 目的: [推測した目的]
2. スコープ: [影響範囲の推測]
3. 期待する動作: [具体的な動作]
4. 制約: [あれば]

選択肢:
1. はい、この要件で進めてください
2. 要件を修正したい（詳細を入力）
3. 不明点があるので質問したい
```

### 要件が曖昧な場合

以下のパターンでは**必ず確認**する:

| 曖昧なパターン | 確認すべき内容 |
|---------------|---------------|
| 「〜を追加」 | どこに？どんな形式で？ |
| 「〜を改善」 | 具体的に何を？どの程度？ |
| 「〜のバグを修正」 | 再現手順は？期待動作は？ |
| 「〜を最適化」 | 何を基準に？許容範囲は？ |

### スキル候補の特定（Phase 0 完了時）

> **詳細**: @_common/skill-triggers.md を参照

要件確認後、変更対象ファイルから自動起動スキルの候補を特定する:

1. 変更対象ファイルの拡張子・パスパターンを skill-triggers.md の検出パターンと照合
2. 該当スキルを `applicable_skills` リストに追加
3. 選択されたモードの制約でフィルタ
4. 要件確認の表示に含める:

```
スキル自動実行予定:
- style-review (VALIDATION, Phase 3.5) - CSS ファイルの変更を検出
- smoke-test (TESTING, Phase 5.5) - ThumbnailThumb 関連の変更を検出 [要確認]
```

> **注意**: `applicable_skills` がない場合（検出パターンに該当なし）はスキル表示を省略し、Phase 3.5/5.5 も自動スキップとなる。

---

## Phase 1: 事前調査 + 類似コード特定（実装モードのみ）

> **モード別動作**: @_common/modes.md を参照

### エージェント定義

> **詳細**: @_common/agents.md を参照

**Phase 1 で使用するエージェント**:
- 必須6エージェント + swiftui-performance-expert（Standard/Maximum/Ultra）
  1. swift-language-expert
  2. swiftui-macos-designer
  3. research-assistant（Phase 1 のみ）
  4. Explore
  5. architecture-reviewer
  6. swiftui-test-expert
  7. swiftui-performance-expert（Phase 4 で常時必須、Phase 1 では View/UI 関連タスク時）
- 条件付き必須エージェント（ファイル内容に応じて追加）
- Maximum 専用エージェント（dependency-analyzer, test-coverage-advisor, refactoring-patterns）
- 非 Swift プロジェクト: @_common/agents.md の「言語別エージェント置換ルール」に従い #1-2 を置換

**Minimum / Minimum+ モード時のエージェント（3つのみ、直列）**:
1. swift-language-expert
2. architecture-reviewer
3. swiftui-test-expert

---

## Phase 1.1: クロスレビュー（実装モードのみ）

> **Minimum モード**: このフェーズは省略
> **Minimum+ モード**: 実行（3エージェント間ペアリング。@_common/cross-review.md の「Minimum+ モード用ペアリング」を参照）
> **Ultra モード**: このフェーズは省略（Phase 4.3 で代替）

Phase 1 の各エージェント出力を、**別の観点を持つエージェントが検証**する。

### クロスレビュー仕様

> **詳細**: @_common/cross-review.md を参照

### 統合エージェントによる結果統合

クロスレビュー完了後、**統合エージェント**を起動して結果を統合。
統合プロンプトは @_common/cross-review.md の「Phase 1.1 統合用」を参照。

### 調査結果の確認（ユーザー確認ポイント）

統合完了後、AskUserQuestion で確認:

```
質問: 「調査結果に漏れはありますか？」

調査結果サマリー:
- 類似コード: [Explore が特定したファイル:行]
- 技術方針: [swift-language-expert の提案]
- 設計観点: [architecture-reviewer の指摘]
- テスト観点: [swiftui-test-expert の指摘]

選択肢:
1. この調査結果で設計書作成に進む
2. 追加調査が必要（詳細を入力）
3. 別の観点から調査してほしい
```

---

## Phase 1.5: 設計書作成・ユーザー承認（実装モードのみ）

調査結果を元に設計書を作成し、実装前にユーザーの承認を得る。

### 設計書フォーマット

```markdown
## 設計書: [タスク名]

### 1. 概要
[タスクの目的と期待される結果]

### 2. 参考にする類似コード
| ファイル | 行番号 | 参考ポイント |
|---------|--------|-------------|
| [パス] | [N-M行] | [何を参考にするか] |

### 3. 変更ファイル一覧
| ファイル | 変更内容 | 新規/修正 |
|---------|---------|----------|
| [パス] | [概要] | 新規/修正 |

### 4. 実装方針
1. [ステップ1]
2. [ステップ2]
...

### 5. テスト方針
- [ ] [テスト1]
- [ ] [テスト2]

### 6. リスク・懸念点
- [あれば記載]
```

### Minimum / Minimum+ モード用設計書（簡潔版）

```markdown
## 設計書: [タスク名]

### 1. 実装方針
1. [ステップ1]
2. [ステップ2]

### 2. 変更ファイル
- [ファイル1]: [変更概要]
- [ファイル2]: [変更概要]

### 3. テスト方針
- [ ] [テスト1]
```

### ユーザー承認

```
質問: 「この設計で実装を進めてよいですか？」

選択肢:
1. はい、この設計で進めてください
2. 設計を修正したい
3. 追加の調査が必要
4. キャンセル
```
