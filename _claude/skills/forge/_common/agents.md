# Forge エージェント定義

この文書は Forge skill で使用するエージェントの共通定義です。

---

## 共通出力フォーマット仕様

**重要**: 全エージェントは以下の構造で出力すること。

### 必須セクション

```markdown
## [ドメイン] 分析/レビュー結果

### 概要
[1-2文で主要発見をサマリー]

### 発見事項

#### High: [カテゴリ]
- **[Issue Title]**
  - 場所: `filepath:line_number`
  - 問題: [詳細説明]
  - 影響: [なぜ問題か]
  - 推奨: [修正案]

#### Medium: [カテゴリ]
[同様の形式]

#### Low: [カテゴリ]
[同様の形式]

### 推奨アクション
1. [優先度順アクション]
2. [次のアクション]
```

### 優先度ラベル（統一基準）

| ラベル | 定義 | 対応期限 | 具体例 |
|--------|------|---------|--------|
| **High** | セキュリティ脆弱性、クリティカルバグ、破壊的変更、データロスリスク | 即時 | 強制アンラップ、retain cycle、未処理エラー |
| **Medium** | パフォーマンス問題、保守性懸念、テストカバレッジ不足、一貫性違反 | 計画的 | 不要な再描画、50行超メソッド、命名不統一 |
| **Low** | コードスタイル、軽微な改善、ドキュメント不足 | 任意 | コメント追加、フォーマット調整 |

### ファイル参照形式（統一）

```
場所: `filepath:line_number`

例:
- 場所: `CanvasViewModel.swift:150`
- 場所: `Sources/Models/Element.swift:42-55`（範囲指定）
```

### クロスレビュー時の記号

> **詳細**: `@_common/cross-review.md` の「出力形式」セクションを参照

| 記号 | 意味 |
|------|------|
| ✅ | 同意（指摘が妥当） |
| ⚠️ | 要検討（追加の考慮が必要） |
| ❌ | 過剰（指摘が過剰反応） |
| 💡 | 追加指摘（見落とされた問題） |

---

## 並行エージェント統合戦略

> **重要**: 並行エージェント起動**前**に統合戦略を定義すること。これにより、セッション中断時も再開が容易になる。

### 統合戦略の指定（必須）

並行エージェント起動時に、以下を明示する：

```
【統合戦略】
1. 出力形式: JSON | Markdown
2. マージルール: 重複排除方法（同一ファイル+行+カテゴリ）
3. 矛盾解決: 両論併記 | 高 confidence 優先 | 多数決
4. 最終出力: テーブル | リスト | JSON
```

### 構造化 JSON 出力の活用

並行エージェントには以下の JSON 形式での出力を指示する：

```json
{
  "agent": "agent-name",
  "file": "target-file",
  "issues": [
    {
      "line": 42,
      "severity": "high" | "medium" | "low",
      "category": "category-name",
      "description": "問題の説明",
      "suggestion": "修正案"
    }
  ]
}
```

> **詳細**: `@_common/cross-review.md` の「構造化出力フォーマット」セクションを参照

### 統合失敗時のリカバリー

| 状況 | 対応 |
|------|------|
| セッション中断 | JSON 出力があれば手動マージ可能 |
| エージェント出力形式不一致 | 統合エージェントが正規化 |
| 矛盾が解決不能 | ユーザーに判断を委ねる |

---

## 必須エージェント（6つ）

以下の6エージェントは Standard/Maximum/Ultra モードで常に使用します。

### 1. swift-language-expert (model: opus)

**Phase 1（事前調査）用プロンプト**:
```
以下のタスクを実装するために必要な Swift 言語の知識を調査してください。
- 関連する言語機能（async/await, actor, protocol 等）
- メモリ管理の考慮点
- エラーハンドリングパターン
タスク: [タスク説明]
既存コードベースの関連部分も確認し、実装方針を提案してください。
```

**Phase 4（レビュー）用プロンプト**:
```
以下のコードを Swift 言語の観点からレビューしてください。
- async/await, actor の使い方
- メモリ管理（retain cycle, weak/unowned）
- エラーハンドリング
- プロトコル/ジェネリクスの設計

**プロジェクト固有ルール（CLAUDE.md より）**:
- 強制アンラップ (force unwrap) は禁止
- `canvases[0]` 等の直接アクセス禁止（`.first` を使用）
- `@unchecked Sendable` 使用時は安全性の理由をコメントで説明
- ImageRenderer, NSHostingView はメインスレッドでのみ使用可

対象: [ファイルパス]
問題点と改善案を箇条書きで報告してください。
```

### 2. swiftui-macos-designer (model: opus)

**Phase 1（事前調査）用プロンプト**:
```
以下のタスクを実装するために必要な SwiftUI/macOS の知識を調査してください。
- 関連する View/State パターン
- 既存の UI コンポーネントとの整合性
- macOS HIG への準拠
タスク: [タスク説明]
既存の View 構造を確認し、実装方針を提案してください。
```

**Phase 4（レビュー）用プロンプト**:
```
以下のコードを SwiftUI/macOS の観点からレビューしてください。
- State管理（@State, @StateObject, @Observable）
- View の再描画パフォーマンス
- macOS HIG 準拠
- NSViewRepresentable の使い方

**プロジェクト固有ルール（CLAUDE.md より）**:
- `@State` プロパティは private にすべき
- `@ObservedObject` の直接初期化禁止（`@StateObject` を使用）
- `.id(UUID())` 禁止（安定した識別子を使用）

対象: [ファイルパス]
問題点と改善案を箇条書きで報告してください。
```

### 3. research-assistant (model: opus) - Phase 1 のみ

**プロンプト**:
```
以下のタスクに関するベストプラクティスと公式ドキュメントを**徹底調査**してください。
- Apple 公式ドキュメント
- 推奨される実装パターン
- 一般的な落とし穴と回避策
- **複数ソースのクロスチェック**
- **反論や代替案の検討**
タスク: [タスク説明]
参考リンクと共に、**信頼性評価を含めて**報告してください。
```

### 4. Explore (model: opus)

**Phase 1（事前調査）用プロンプト**:
```
以下のタスクに関連する既存コードを**徹底的に**調査してください。

【必須】類似機能の特定:
- 同様の機能を持つ既存コードを特定
- そのコードの実装パターンを詳細に報告
- 再利用可能な部分を明示

【必須】影響範囲:
- 変更が必要なファイル一覧
- 依存関係のあるファイル
- 既存テストへの影響

タスク: [タスク説明]

**重要**: 類似コードが見つかった場合、そのファイルパスと該当行番号を
必ず報告してください。実装時にそのパターンを参考にします。
```

**Phase 4（レビュー）用プロンプト**:
```
以下のコードに関連する既存コードを**徹底的に**調査してください。
- 類似機能の実装箇所
- 影響を受けるファイル
- 既存のテストパターン
- **潜在的な影響範囲の深掘り**
対象: [ファイルパス]
関連ファイルと影響範囲を報告してください。
```

### 5. architecture-reviewer (model: opus)

**Phase 1（事前調査）用プロンプト**:
```
以下のタスクのアーキテクチャ観点での設計方針を提案してください。
- 適切なレイヤー配置（View/ViewModel/Model/Service）
- 依存方向の確認
- 責務分離の妥当性
- テスタビリティ
タスク: [タスク説明]
既存アーキテクチャとの整合性を確認し、推奨する設計を報告してください。
```

**Phase 4（レビュー）用プロンプト**:
```
以下のコードをアーキテクチャ観点から**徹底的に**レビューしてください。
- レイヤー配置の適切性
- 依存方向
- 責務分離
- テスタビリティ
- **将来的な拡張性**
対象: [ファイルパス]
問題点と改善案を箇条書きで報告してください。
```

### 6. swiftui-test-expert (model: opus)

**Phase 1（事前調査）用プロンプト**:
```
以下のタスクのテスト戦略を**徹底的に**提案してください。
- 必要なユニットテスト
- リグレッションテスト（既存機能の保護）
- **エッジケースの網羅的な検討**
- **非同期処理のテストパターン**
- **潜在的なフレーキーテストのリスク分析**
タスク: [タスク説明]
既存テストとの整合性も確認してください。
```

**Phase 4（レビュー）用プロンプト**:
```
以下のコードをテスト戦略の観点から**徹底的に**レビューしてください。
- テストカバレッジ戦略
- リグレッションテスト
- 非同期処理のテストパターン
- **エッジケースの網羅的検討**
- **フレーキーテストのリスク分析**
対象: [ファイルパス]
問題点に対するテスト戦略を箇条書きで報告してください。
```

### 7. swiftui-performance-expert (model: opus) - Phase 4 常時必須

**プロンプト**:
```
以下のコードのパフォーマンスをレビューしてください。
- 不要な再描画
- メモリ使用量
- 重い処理のメインスレッドブロック
対象: [ファイルパス]
パフォーマンス上の問題点を報告してください。
```

---

## 条件付き必須エージェント

| 条件 | エージェント | モデル |
|------|-------------|--------|
| View/UI 変更を含む | swiftui-performance-expert | opus |
| async/await, actor, Task を含む | swift-concurrency-expert | opus |
| ファイル操作、外部入力、API 通信 | security-auditor | opus |

---

## 追加エージェント（タスク/ファイル内容に応じて選択）

### Swift/macOS 関連

| 検出パターン | エージェント |
|-------------|-------------|
| `NSViewRepresentable`, `NSHostingView`, `makeNSView` | appkit-swiftui-integration-expert |
| `Canvas`, `Layer`, `Tool`, エディタ関連 | image-editing-expert |
| `Codable`, `JSONEncoder`, `FileManager`, `SwiftData` | data-persistence-expert |
| `NSStatusItem`, `Keychain`, `SecurityScoped` | macos-system-integration-expert |
| Swift 大規模構造変更 | swift-architecture-designer |

### フロントエンド/デスクトップ関連

| 検出パターン | エージェント |
|-------------|-------------|
| `.css`, `.scss`, `styled-components`, `@media`, `flexbox`, `grid` | css-expert |
| `.js`, `.ts`, `package.json`, `express`, `fastify` | nodejs-expert |
| `electron`, `BrowserWindow`, `ipcMain`, `ipcRenderer` | electron-expert |

### バックエンド関連

| 検出パターン | エージェント |
|-------------|-------------|
| `.go`, `go.mod`, `goroutine`, `chan` | go-architecture-designer |
| `.rb`, `Gemfile`, `Rails`, `ActiveRecord` | rails-domain-designer |

### リファクタリング関連

| 検出パターン | エージェント |
|-------------|-------------|
| 大規模リファクタリング、Extract Method/Class、Strangler Fig | refactoring-patterns |

---

## Maximum 専用エージェント

Maximum モード選択時は、以下のエージェントを**必ず追加で並行起動**する：

### dependency-analyzer (model: opus)

**Phase 1 プロンプト**:
```
以下のタスクの影響範囲を分析してください。
- 変更対象ファイルの依存関係マッピング
- 変更による波及効果の予測
- 循環依存の有無
- 影響を受けるテストファイルの特定
タスク: [タスク説明]
影響範囲レポートを作成してください。
```

**Phase 4 プロンプト**:
```
以下のコードの依存関係を分析し、レビュー観点を提供してください。
- ファイル間の結合度評価
- 循環依存の検出
- 変更が他のファイルに与える影響
対象: [ファイルパス]
依存関係の問題点を報告してください。
```

### test-coverage-advisor (model: opus)

**Phase 1 プロンプト**:
```
以下のタスクのテストカバレッジ状況を分析してください。
- 既存テストのカバレッジ評価
- テストギャップの特定
- リファクタリング前に追加すべきテスト
- リグレッション防止戦略
タスク: [タスク説明]
テスト戦略レポートを作成してください。
```

**Phase 4 プロンプト**:
```
以下のコードのテストカバレッジをレビューしてください。
- テストギャップの特定
- 追加すべきテストケース
- リグレッションリスクの評価
対象: [ファイルパス]
テストに関する推奨事項を報告してください。
```

### refactoring-patterns (model: opus) - リファクタ系タスクのみ

**条件**: タスクが「リファクタ」「分割」「抽出」「移動」「整理」を含む場合

**Phase 1 プロンプト**:
```
以下のリファクタリングタスクの安全な実行手順を設計してください。
- 適用すべきリファクタリングパターンの選定
- 段階的な実行ステップ
- 各ステップのロールバック方法
- 破壊的変更の回避策
タスク: [タスク説明]
リファクタリング計画を作成してください。
```

**Phase 4 プロンプト**:
```
以下のコードをリファクタリングの観点からレビューしてください。
- Extract Method/Class の機会
- 重複コードの統合可能性
- 段階的移行戦略（Strangler Fig）
- 既存動作を壊さない変更方法
- テストの維持方針
対象: [ファイルパス]
安全なリファクタリング戦略を報告してください。
```

---

## 言語別エージェント置換ルール

非 Swift プロジェクトでは、必須エージェント #1-2 を以下の言語別エージェントに置き換える：

| 検出条件 | 置換エージェント | 代替する必須エージェント |
|---------|-----------------|----------------------|
| `.go`, `go.mod` | go-architecture-designer | swift-language-expert |
| `.rb`, `Gemfile`, Rails | rails-domain-designer | swift-language-expert, swiftui-macos-designer |
| `.css`, `.scss`, CSS-in-JS | css-expert | swiftui-macos-designer |
| `.js`, `.ts`, `package.json` | nodejs-expert | swift-language-expert |
| `electron`, `BrowserWindow` | electron-expert | (追加のみ、置換なし) |
