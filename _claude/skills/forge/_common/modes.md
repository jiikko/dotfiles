# Forge モード定義

この文書は Forge skill の全フェーズで共通のモード定義です。

## モード一覧

| モード | エージェント数 | 実行方式 | クロスレビュー | スキル自動起動 | 用途 |
|-------|--------------|---------|--------------|--------------|------|
| **Minimum** | 3 | 並行 | 省略 | なし | 軽量タスク、単純な修正 |
| **Minimum+** | 3 | 並行 | 実行 | なし | 軽量タスク + 品質検証 |
| **Standard** | 6+1 | 並行 | 実行 | VALIDATION のみ | 通常の実装・レビュー |
| **Maximum** | 全て | 並行 | 実行 | 全カテゴリ | 重要機能、大規模変更 |
| **Ultra** | 全て | 反復並行 | Phase 4.3 | 全カテゴリ | 複雑なデバッグ、原因不明のバグ |

## モード別詳細

### Minimum モード
- **エージェント**: 3エージェントを**並行実行**
  - swift-language-expert
  - architecture-reviewer
  - swiftui-test-expert
- **クロスレビュー**: 省略
- **統合**: 省略（直接結果を使用）

### Minimum+ モード
- **エージェント**: Minimum と同じ3エージェントを**並行実行**
  - swift-language-expert
  - architecture-reviewer
  - swiftui-test-expert
- **クロスレビュー**: Phase 1.1 / Phase 4.1 を実行（3エージェント間ペアリング）
- **統合**: Phase 4.2 を実行
- **ペアリング**: @_common/cross-review.md の「Minimum+ モード用ペアリング」を参照

### Standard モード
- **エージェント**: 必須6+1エージェントを**並行実行**
- **クロスレビュー**: Phase 1.1 / Phase 4.1 を実行
- **統合**: Phase 1.1統合 / Phase 4.2 を実行

### Maximum モード
- **エージェント**: 全エージェント（条件付き含む）を**並行実行**
- **追加エージェント**: dependency-analyzer, test-coverage-advisor, refactoring-patterns
- **クロスレビュー**: Phase 1.1 / Phase 4.1 を実行
- **統合**: Phase 1.1統合 / Phase 4.2 を実行

### Ultra モード
- **エージェント**: 全エージェントを**反復並行実行**
- **クロスレビュー**: Phase 4.3（反復並列思考）を実行
- **Phase 4.1/4.2**: 省略（Phase 4.3 に置き換え）
- **収束条件**: 全エージェントから「新たな発見なし」または最大3ラウンド

## モード推奨ロジック（スコアリングシステム）

### スコア計算因子

| Factor | Score | 条件 |
|--------|-------|------|
| **ファイル影響度** | 1 | 1-2ファイル |
| | 2 | 3-4ファイル |
| | 3 | 5-7ファイル |
| | 4 | 8ファイル以上 |
| **変更規模** | 1 | ~30行 |
| | 2 | 31-100行 |
| | 3 | 101行以上 |
| **構造変更** | +1 | Protocol 追加/変更 |
| | +1 | 新型（class/struct/enum）定義 |
| | +1 | import 追加（新依存） |
| **デバッグキーワード** | +2 | デバッグキーワード検出（下記参照） |
| **軽微変更キーワード** | -1 | 軽微変更キーワード検出（下記参照） |

> **注意**: 構造変更は実際のコード変更内容から +1 ずつ加算。キーワード検出は別途スコア加算。

### スコア→モード変換

| Total Score | Mode | 根拠 |
|-------------|------|------|
| 0-2 | Minimum / Minimum+ | 影響範囲が限定的、単純な変更（品質検証が必要なら Minimum+）|
| 3-5 | Standard | 通常の機能追加・修正 |
| 6-8 | Maximum | 広範な影響、構造変更を含む |
| 9+ | Ultra | 複雑なタスク、原因調査が必要 |

**例外**: Ultra キーワード検出時は即座に Ultra 推奨

### キーワード定義

#### Ultra 直接トリガー（即座に Ultra 推奨）
```
原因不明, 原因がわからない, なぜか動かない, 理由不明,
crash, freeze, ハング, 無限ループ, メモリリーク,
race condition, デッドロック
```

#### デバッグキーワード（Score +2）
```
バグ, bug, fix, 修正, 不具合, エラー, error,
例外, exception, 動作しない, 期待通り, おかしい
```

#### 構造変更キーワード（構造変更検出のヒント）
```
リファクタ, refactor, 設計変更, アーキテクチャ, architecture,
モジュール, 依存, dependency, Protocol, インターフェース,
抽象化, 分離, レイヤー
```
> **注意**: これらのキーワードは構造変更（+1〜+3）の検出ヒント。キーワード自体での加算はなし。

#### 軽微変更キーワード（Score -1）
```
typo, タイポ, コメント, ドキュメント, README,
変数名, リネーム, フォーマット, lint
```

### フォールバック戦略

| 状況 | 対応 |
|------|------|
| 境界スコア（2, 5, 8） | より安全な上位モードを推奨 |
| 情報不足 | Standard をデフォルト推奨 |
| 複合条件で判断困難 | 推奨理由を明記してユーザーに選択を委ねる |

### モード再評価タイミング

| タイミング | トリガー条件 |
|-----------|-------------|
| Phase 0 完了後 | 推定ファイル数が初期判定の2倍以上 |
| Phase 1.5 完了後 | 新規 Protocol/型が3つ以上追加 |
| Phase 4 中 | Critical 指摘が2件以上 |

### 従来の簡易判定（参考）

| タスク特徴 | 推奨モード | 判定基準 |
|-----------|----------|---------|
| 単一ファイル、小規模変更 | Minimum / Minimum+ | 影響ファイル数 ≤ 3、修正行数 ≤ 50（品質検証が必要なら Minimum+）|
| 通常の機能追加・バグ修正 | Standard | 上記以外の通常タスク |
| 複数ファイル、アーキテクチャ変更 | Maximum | 影響ファイル数 ≥ 4、構造変更を含む |
| 「動かない」「原因不明」「デバッグ」 | Ultra | デバッグ系キーワードを含む |

## 各フェーズでの動作

| フェーズ | Minimum | Minimum+ | Standard | Maximum | Ultra |
|---------|---------|----------|----------|---------|-------|
| Phase 0 | 実行 | 実行 | 実行 | 実行 | 実行 |
| Phase 1 | 3並行 | 3並行 | 6並行 | 全員並行 | 全員並行 |
| Phase 1.1 | **省略** | 実行 | 実行 | 実行 | **省略** |
| Phase 1.5 | 簡略 | 簡略 | 標準 | 拡張 | 拡張 |
| Phase 2-3 | 実行 | 実行 | 実行 | 実行 | 実行 |
| Phase 3.5 | **省略** | **省略** | 実行 | 実行 | 実行 |
| Phase 4 | 3並行 | 3並行 | 6並行 | 全員並行 | 全員並行 |
| Phase 4.1 | **省略** | 実行 | 実行 | 実行 | **省略** |
| Phase 4.2 | **省略** | 実行 | 実行 | 実行 | **省略** |
| Phase 4.3 | - | - | - | - | **実行** |
| Phase 4.5 | 実行 | 実行 | 実行 | 実行 | 実行 |
| Phase 5 | 実行 | 実行 | 実行 | 実行 | 実行 |
| Phase 5.5 | **省略** | **省略** | **省略** | 実行 | 実行 |
